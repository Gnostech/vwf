<!DOCTYPE html>

<!-- Copyright 2012 United States Government, as represented by the Secretary of Defense, Under  -->
<!-- Secretary of Defense (Personnel & Readiness).                                               -->
<!--                                                                                             -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file   -->
<!-- except in compliance with the License. You may obtain a copy of the License at              -->
<!--                                                                                             -->
<!--   http://www.apache.org/licenses/LICENSE-2.0                                                -->
<!--                                                                                             -->
<!-- Unless required by applicable law or agreed to in writing, software distributed under the   -->
<!-- License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,   -->
<!-- either express or implied. See the License for the specific language governing permissions  -->
<!-- and limitations under the License.                                                          -->

<html>
  <head>
	<script type="text/javascript" src="TCDriver.js"></script>
	<script type="text/javascript" src="base64.js"></script>
	<script type="text/javascript">
	
	
	function findChildColladaNode(node, name)
         {
            
            if(node.colladaId == name)
                return node;
            else if(node.children){
                for(var i = 0; i < node.children.length; i++) {
                    var child = findChildColladaNode(node.children[i],name);
                    if(child) return child;
                }
            }
            return null;
         }
         function findChildViewNode(node, name)
         {
            
            if(node.vwfID == name)
                return node;
            else if(node.children){
                for(var i = 0; i < node.children.length; i++) {
                    var child = findChildViewNode(node.children[i],name);
                    if(child) return child;
                }
            }
            return null;
         }
         function recurseshow(obj, depth)
         {
             if(!obj) return null;		 
             if(depth > 1) return null;
             depth++;
             var keys = {};
             if(obj.__proto__) keys['proto'] = recurseshow(obj.__proto__,depth);
             for (var key in obj) if(key != 'parent' && key != 'vertices'){
                if(obj[key] && obj[key].constructor === String) keys[key] = obj[key];
                else keys[key] = recurseshow(obj[key],depth) ;
             }
             return keys;
         }
         function debugshow(obj)
         {
            var keys = recurseshow(obj,0);
            var data = "data:application/json;UTF8," + (JSON.stringify(keys));
            window.open(data);	 
         }
         function findscene(vwf)
         {
            
             return vwf.views[0].state.scenes["index-vwf"].glgeScene;
             
             return null;
         }
	
	vwf_view.satProperty = function(id,prop,val)
	{
		var node = this.nodes && this.nodes[id];
		if(node)
		{
			if(prop == 'steerAmt')
			{
				node.steerAmtView();
			}
			if(prop == 'wheelRotate')
			{
				node.wheelRotateView();
			}
		}
	}
	vwf_view.calledMethod = function(id,prop,val)
	{
		var node = this.nodes && this.nodes[id];
		if(node)
		{
			
			if(prop == 'update')
			{
				
				node.updateView(window);
			}
		}
	}
	vwf_view.createdNode = function(nodeID, childID, childExtendsID, childImplementsIDs, childSource, childType, childURI, childName)
	{
		if(nodeID)   //ignore prototypes
		{
			if(childExtendsID == 'hmvee.vwf')    // if this node is a player
			{
				if(!this.nodes)
				   this.nodes = {};
				this.nodes[childID] =  vwf.models[0].model.nodes[childID].node;  
			}
		}
	}
	
	vwf_view.initializedNode = function( nodeID, childID )
	{
		var node = this.nodes && this.nodes[childID];
		if(node)
		{
			node.initializeView = function(context)
			{
						
						
						
						var root = findChildViewNode(findscene(vwf),this.id);       
						this.tireRF = findChildColladaNode(root,'passenger_side_front_wheel');
						this.tireRB = findChildColladaNode(root,'passenger_side_back_wheel');
						this.tireLF = findChildColladaNode(root,'driver_side_front_wheel');
						this.tireLB = findChildColladaNode(root,'driver_side_back_wheel');
						this.turret = findChildColladaNode(root,'turret');
						
						//this.AmFirstClient();
						document[this.PlayerNumber +'link'] = this;
						//If the player that is initializing is the local player, then link up the keypress handlers
						if(document.PlayerNumber == this.PlayerNumber)
						{
							
							$(document).mousemove(function(e){  document[this.PlayerNumber +'link'].pointerMove(e);});                    
							$(document).keydown(function(e){  document[this.PlayerNumber +'link'].keydown(e);});
							$(document).keyup(function(e){document[this.PlayerNumber +'link'].keyup(e);});
						}
						  var newdiv = document.createElement('div');
						  newdiv.style.position = 'absolute';
						  newdiv.id = "Player " + this.PlayerNumber + 'label';
						  newdiv.innerHTML = "Player " + this.PlayerNumber;
						  newdiv.style.left = '0px';
						  newdiv.style.top = '0px';
						  newdiv.style.background = 'white';
						  document.body.appendChild(newdiv);
						  
						  var hitscreen = document.createElement('img');  
						  hitscreen.src = 'hitscreen.png';
						  hitscreen.style.position = 'absolute';
						  hitscreen.style.width = '100%';
						  hitscreen.style.height = '100%';
						  hitscreen.style.left = '0';
						  hitscreen.style.top = '0';
						  hitscreen.style.opacity = '0';
						  hitscreen.id = "hitscreen";
						  document.body.appendChild(hitscreen);
					
			}
			node.updateView = function()
			{
			 
				
					this.turret.setRotZ(this.lookAngle);
					
					this.updateCamera(document);
					
				  var div = document.getElementById("Player " + this.PlayerNumber + 'label');
				  var pos = this.translation;
				  pos = [pos[0],pos[1],pos[2]+3,1];
					 
				  var viewprojection = window.vwf.views[0].state.cameraInUse.getViewProjection();
				  var screen = GLGE.mulMat4Vec4(viewprojection,pos);
				  screen[0] /= screen[3];
				  screen[1] /= screen[3];
				  screen[2] /= screen[3];
				  screen[0] /= 2;
				  screen[1] /= 2;
				  screen[2] /= 2;
				  screen[0] += .5;
				  screen[1] += .5;
				  screen[2] += .5;
			  
				  screen[0] *= window.innerWidth;
				  screen[1] *= window.innerHeight;
				  screen[2] *= window.innerHeight;
				 
				  screen[1] = window.innerHeight - screen[1];
				 
				  
				  div.style.left = screen[0]  +'px';
				  div.style.top = screen[1]  +  'px';
				  div.innerHTML = this.PlayerNumber + " " + this.Health;
				  
				  div.style.left = (screen[0] - div.offsetWidth/2)  +'px';
				  
				
			}
			node.updateCamera = function(document)
			{
					  
					  if(document["PlayerNumber"] != this.PlayerNumber)
						  return;
					  var cameraTarget = vwf_view.kernel.kernel.models[0].model.nodes['http-vwf-example-com-node3-vwf-' + this.camtarget];
					  if(!cameraTarget)
							cameraTarget = this;
					  else
							return;
							
					  var camera = window.vwf.views[0].state.cameraInUse;
					  var camoffset = [];
					  camoffset = GLGE.mulMat4Vec3(GLGE.angleAxis(this.RotationAmt+this.lookAngle,[0,0,1]),[0,-20,8]);
				
					  var cameragoal = [cameraTarget.translation[0]+camoffset[0],cameraTarget.translation[1]+camoffset[1],cameraTarget.translation[2]+camoffset[2]];
					  var togoal = [cameragoal[0] - camera.getLocX(),
									cameragoal[1] - camera.getLocY(),
									cameragoal[2] - camera.getLocZ()];
					  var blendfactor = 30;
					  
							
					  camera.setLoc(camera.getLocX() + togoal[0]/blendfactor,
									camera.getLocY() + togoal[1]/blendfactor,
									camera.getLocZ() + togoal[2]/blendfactor);
					  camera.Lookat([cameraTarget.translation[0],cameraTarget.translation[1],cameraTarget.translation[2]+2]);
			 
			 
			}
			node.keydown = function(e)
			{
           
			  // debugger;
			   //Only the local player is controlled by the keypresses
			   if(document["PlayerNumber"] != this.PlayerNumber)
			              return;
				 
				if(e.keyCode == 65 && this.ADown == true) return;
				if(e.keyCode == 68 && this.DDown == true) return;
				if(e.keyCode == 87 && this.SDown == true) return;
				if(e.keyCode == 83 && this.WDown == true) return;
				 
				if(e.keyCode == 65) vwf_view.kernel.callMethod(this.id,'localKeyDown',['A'],0,null);
				if(e.keyCode == 68) vwf_view.kernel.callMethod(this.id,'localKeyDown',['D'],0,null);
				if(e.keyCode == 87) vwf_view.kernel.callMethod(this.id,'localKeyDown',['S'],0,null);
				if(e.keyCode == 83) vwf_view.kernel.callMethod(this.id,'localKeyDown',['W'],0,null);
			}
			node.keyup = function(e)
			{
				 
				 //Only the local player is controlled by the keypresses
			    if(document["PlayerNumber"] != this.PlayerNumber)
			              return;
						  
				  if(e.keyCode == 65) vwf_view.kernel.callMethod(this.id,'localKeyUp',['A'],0,null);
				  if(e.keyCode == 68) vwf_view.kernel.callMethod(this.id,'localKeyUp',['D'],0,null);
				  if(e.keyCode == 87) vwf_view.kernel.callMethod(this.id,'localKeyUp',['S'],0,null);
				  if(e.keyCode == 83) vwf_view.kernel.callMethod(this.id,'localKeyUp',['W'],0,null);
				  if(e.keyCode == 32)
				 {
					window.vwf.send(this.id,'callMethod','fire',0,null);
				 }
			}
			node.steerAmtView = function()
			{
				this.wheelRotMatrix	= this.BuildSteerMatrix();		
				this.tireRF.setRotMatrix(this.wheelRotMatrix);
				this.tireLF.setRotMatrix(this.wheelRotMatrix);	
			}
			node.wheelRotateView = function()
			{
				this.wheelRotMatrix	= this.BuildSteerMatrix();		
				this.tireRF.setRotMatrix(this.wheelRotMatrix);
				this.tireLF.setRotMatrix(this.wheelRotMatrix);	
				this.tireRB.setRotX(this.wheelRotate);	
				this.tireLB.setRotX(this.wheelRotate);
			}
			 
			node.BuildSteerMatrix = function()
			{
				
				 var steermat = goog.vec.Quaternion.fromAngleAxis(-this.steerAmt,[0,0,1],[0,0,0]);		  
				 steermat = goog.vec.Quaternion.toRotationMatrix4(steermat,goog.vec.Mat4.create());
				 var sidevec = goog.vec.Mat4.multVec3(steermat,[0,1,0],[0,0,0]);
				
				 
				 
				 var spinmat = goog.vec.Quaternion.fromAngleAxis(-this.steerAmt,[0,0,1],[0,0,0]);		  
				 spinmat = goog.vec.Quaternion.toRotationMatrix4(spinmat,goog.vec.Mat4.create());
				 return goog.vec.Mat4.multMat(spinmat,steermat,goog.vec.Mat4.create());
			}
			node.pointerMove = function( parms, pickInfo ){

				  if(document["PlayerNumber"] != this.PlayerNumber)
						  return;
				  vwf_view.kernel.callMethod(this.id,'localpointerMove',[{clientX:parms.clientX,clientY:parms.clientY}],0,null)
				 
			}
			node.initializeView();
		}
	}
	var PlayerProto  = { 
                    
                    extends: 'hmvee.vwf',
                    source: 'matv01_veh.dae',
                    type: 'model/vnd.collada+xml',
                    properties: {
                        PlayerNumber: 1,
						rotation: [ 1, 0, 0, 90 ],
						translation: [0,0,1],
						initialPos: [10,10,1],
						initialRot: [0,0,0,1],
						initialHealth: 100,
						initialRotAmt: 0,
						initialSteerAmt:0,
						initialWheelRotate:0
                        },
                    };
	
	function Begin()
	{
	    
		
		var name = $('#name').val();
		$('#Logon').dialog('close');
		PlayerProto.properties.PlayerNumber = name;
		PlayerProto.properties.initialPos[0] = (Math.random() * 80)-40;
		PlayerProto.properties.initialPos[1] = (Math.random() * 80)-40;
		PlayerProto.properties.initialPos[2] = (Math.random() * 80)-40;
		PlayerProto.properties.initialRot[0] = 90;
		PlayerProto.properties.initialRot[1] = 0;
		PlayerProto.properties.initialRot[2] = 1;
		PlayerProto.properties.initialRot[3] = 0;
		PlayerProto.properties.initialHealth = 100;
		PlayerProto.properties.initialRotAmt = 0;
		PlayerProto.properties.initialSteerAmt = 0;
		PlayerProto.properties.initialWheelRotate = 0;
		
		
		document[name + 'link'] = null;
		PlayerProto.properties.PlayerNumber = name;
		//PlayerProto.id = "player"+name;
		document["PlayerNumber"] = name;
		var parms = new Array();
		parms.push(JSON.stringify(PlayerProto));
		
		//console.log(vwf_view);
		//vwf_view.kernel.callMethod('index-vwf','newplayer',parms);
		newplayer(PlayerProto);
		
		
	}
	function SendSelf()
	{
		//This will be called by the scene when a player is created. This sends a prototype for the local player to all remote machines.
		//Because this will be called on the local client when creating his own player, filter if he is not yet created;
		if(!document[document.PlayerNumber +'link'])
		    return;
	    var name = $('#name').val();
		PlayerProto.properties.PlayerNumber = name;
		PlayerProto.properties.initialPos[0] = document[document.PlayerNumber +'link'].translation[0];
		PlayerProto.properties.initialPos[1] = document[document.PlayerNumber +'link'].translation[1];
		PlayerProto.properties.initialPos[2] = document[document.PlayerNumber +'link'].translation[2];
		PlayerProto.properties.initialRot[0] = document[document.PlayerNumber +'link'].rotation[0];
		PlayerProto.properties.initialRot[1] = document[document.PlayerNumber +'link'].rotation[1];
		PlayerProto.properties.initialRot[2] = document[document.PlayerNumber +'link'].rotation[2];
		PlayerProto.properties.initialRot[3] = document[document.PlayerNumber +'link'].rotation[3];
		PlayerProto.properties.initialHealth = document[document.PlayerNumber +'link'].Health;
		PlayerProto.properties.initialRotAmt = document[document.PlayerNumber +'link'].RotationAmt;
		PlayerProto.properties.initialSteerAmt = document[document.PlayerNumber +'link'].steerAmt;
		PlayerProto.properties.initialWheelRotate = document[document.PlayerNumber +'link'].wheelRotate;
		var parms = new Array();
		parms.push(JSON.stringify(PlayerProto));
		vwf_view.kernel.callMethod('index-vwf','newplayer',parms);
		
	}
	function newplayer(e)
    {
        window.vwf = vwf;
        var proto = e;//JSON.parse(e);
        
        //Because SendSelf will create circular messages, don't create a guy who is already created.
        var newname = "player-"+proto.properties.PlayerNumber;
        
        //if(!document[proto.properties.PlayerNumber + 'link'])
        {
            //debugger;
            //When a new player is created, you'll have to let the new guy know that you exist. SendSelf does this.
           // SendSelf();
            
            //This is odd. It seems like supplying an ID for the new object causes the initialize not to fire
            //proto.id = "player-"+proto.properties.PlayerNumber;
            //proto.uri = "player-"+proto.properties.PlayerNumber;
            vwf_view.kernel.createChild("index-vwf","player-"+proto.properties.PlayerNumber,proto);
        }
    }
	function testhit()
	{
		vwf_view.kernel.callMethod(document[document.PlayerNumber +'link'].id,'hit',[]);
	}
	function SceneInitialize()
	{
		$(window).unload(function(){SceneDestroy();});
		$('#Logon').dialog({title:'Enter Name',modal:true,buttons:{"Play!":function(){Begin();}}});
	}
	function SceneDestroy()
	{
		
	    var parms = new Array();
		parms.push(document[document.PlayerNumber +'link'].id);
		//alert(JSON.stringify(parms));
		vwf_view.kernel.callMethod('index-vwf','deleteplayer',parms);
	}
	$(document).ready(function(){SceneInitialize();});
	
	</script>	
	<script language="JavaScript">
	function disableEnterKey(e)
	{
		 var key;
		 if(window.event)
			  key = window.event.keyCode;     //IE
		 else
			  key = e.which;     //firefox
		 if(key == 13)
			  return false;
		 else
			  return true;
	}
	</script>


  </head>
  <body>
    
    <div id='Logon'>
		<form>
				<input type="text" name="name" id="name" onKeyPress="return disableEnterKey(event)" class="text ui-widget-content ui-corner-all" />
		</form>
	</div>
	<div id='passworddialog'>
		<form>
				<input type="password" name="password" id="password" onKeyPress="return disableEnterKey(event)" class="text ui-widget-content ui-corner-all" />
		</form>
	</div>
	<div id='createprofile'>
		<form>
		        <label style='font-size:small' for="password">Password:</label> 
				<input type="password" name="password" id="ProfilePassword" onKeyPress="return disableEnterKey(event)" class="text ui-widget-content ui-corner-all" />
				<label style='font-size:small' for="password2">Confirm:</label> 
				<input type="password" name="password2" id="ProfilePassword2" onKeyPress="return disableEnterKey(event)" class="text ui-widget-content ui-corner-all" />
				<label style='font-size:small' for="ProfileName">Name:</label> 
				<input type="text" name="Name" id="ProfileName" onKeyPress="return disableEnterKey(event)" class="text ui-widget-content ui-corner-all" />
				<label style='font-size:small' for="ProfileEmail">EMail:</label> 
				<input type="text" name="Email" id="ProfileEmail" onKeyPress="return disableEnterKey(event)" class="text ui-widget-content ui-corner-all" />
		</form>
	</div>
	<div id='gameover'></div>
  </body>
</html>
